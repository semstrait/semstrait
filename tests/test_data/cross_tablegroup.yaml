# Cross-DatasetGroup Test Fixture
# Tests: UNION across multiple datasetGroups with different measures
#
# Expected behavior:
# - unified_cost metric should generate a UNION of both datasetGroups
# - Each branch should aggregate its own measure (ad_cost vs media_spend)
# - Final result should re-aggregate the unioned data
# - Model-level dimensions (dates) can be queried with 2-part paths across datasetGroups

semantic_models:
  - name: marketing
    # Model-level dimensions - queryable with 2-part paths across all datasetGroups
    dimensions:
      - name: _dataset
        virtual: true
        attributes:
          - name: model
            type: string
          - name: datasetGroup
            type: string
          - name: table
            type: string

      # Shared dates dimension - queryable as dates.date, dates.year
      - name: dates
        attributes:
          - name: date
            type: date
          - name: year
            type: i32

    datasetGroups:
      # Google Ads data
      - name: google_ads
        dimensions:
          - name: dates
            attributes:
              - name: date
                type: date
              - name: year
                type: i32

          - name: campaign
            attributes:
              - name: campaign_id
                type: string
              - name: campaign_name
                type: string
          
          # Virtual dimension reference
          - name: _dataset

        measures:
          - name: ad_cost
            aggregation: sum
            expr: cost
            type: f64

          - name: clicks
            aggregation: sum
            expr: clicks
            type: i64

          - name: impressions
            aggregation: sum
            expr: impressions
            type: i64

        datasets:
          - dataset: marketing.google_ads_daily
            source:
              type: parquet
              path: /data/marketing/google_ads_daily.parquet
            dimensions:
              dates: [date, year]
              campaign: [campaign_id, campaign_name]
              _dataset: [model, datasetGroup, dataset]
            measures: [ad_cost, clicks, impressions]

      # Meta (Facebook) Ads data
      - name: meta_ads
        dimensions:
          - name: dates
            attributes:
              - name: date
                type: date
              - name: year
                type: i32

          - name: campaign
            attributes:
              - name: campaign_id
                type: string
              - name: campaign_name
                type: string
          
          # Virtual dimension reference
          - name: _dataset

        measures:
          - name: media_spend
            aggregation: sum
            expr: spend
            type: f64

          - name: clicks
            aggregation: sum
            expr: link_clicks
            type: i64

          - name: impressions
            aggregation: sum
            expr: impressions
            type: i64

        datasets:
          - dataset: marketing.meta_ads_daily
            source:
              type: parquet
              path: /data/marketing/meta_ads_daily.parquet
            dimensions:
              dates: [date, year]
              campaign: [campaign_id, campaign_name]
              _dataset: [model, datasetGroup, dataset]
            measures: [media_spend, clicks, impressions]

    # Metrics
    metrics:
      # Simple metric that exists in both datasetGroups
      - name: clicks
        type: i64
        expr: clicks
      
      - name: impressions
        type: i64
        expr: impressions
      
      # Cross-datasetGroup metric (different measures per datasetGroup)
      - name: unified_cost
        type: f64
        expr:
          case:
            when:
              - condition:
                  eq: [datasetGroup.name, "google_ads"]
                then: ad_cost
              - condition:
                  eq: [datasetGroup.name, "meta_ads"]
                then: media_spend
            else: 0

# No shared dimensions (all dimensions are degenerate/inline)
